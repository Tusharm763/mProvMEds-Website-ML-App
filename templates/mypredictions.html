<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='modern-styles.css') }}">
    <title>My Predictions - mProvMeds</title>
    <script src="{{ url_for('static', filename='this-script.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>

<body><div class="message-mobile" id="mobileMessage" >
        Regret!!
        <br>
        <br>

        Please use our app for mobile phone:
        <br>
        <br>
        Play-Store: URL-not-found
        <br>
        <br>
        Thanks and Regards.
        {{appname}} Team.
    </div>
    <nav class="navbar" id="nb">
        <div class="nav-left">
            <a href="{{ url_for('index') }}" class="app-name"
                style="display: flex; justify-content: center; align-items: center;">
                <img style="border-radius: 50%;margin-right: 8px;"
                    src="{{ url_for('static', filename='mProvMEds-logo-Icon-circular.png') }}"
                    alt="Flowers in Chania" height="40" width="40">

                {{ appname }} </a>
            <div style="border-left: 3px solid #2563eb;height: 45px;">
            </div>

            <ul class="nav-links">
                <li><a href="{{ url_for('index_form') }}" class="nav-link">Create Prediction</a></li>
                <li><a href="{{ url_for('my_predictions') }}" class="nav-link">My Predictions</a></li>
                <li><a href="{{ url_for('about') }}" class="nav-link">About Us</a></li>
            </ul>
        </div>

        {% if username %}
        <div class="user-dropdown">
            <button class="user-button" onclick="toggleDropdown()">
                <span id="userName">{{ username }}</span>
                <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-item">Signed in as <strong>{{ username }}</strong></div>
                <div class="dropdown-item" id="userEmail">Email - id: {{ email }}</div>
                <div class="dropdown-item">
                    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
                </div>
            </div>
        </div>
        {% endif %}
    </nav>

    <div class="container main-content fade-in" id="cmc">
        <div class="predictions-container">
            <div class="heading-title" style="text-align: center; margin-bottom: 2rem;">
                <h2>üìä My Prediction History</h2>
                <p style="color: var(--text-secondary);">Track your health predictions and symptoms over time</p>
            </div>

            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div
                    style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
                    <h3 style="color: var(--primary-dark); margin: 0; font-size: 2rem;">{{ predictions|length }}</h3>
                    <p style="color: var(--primary-dark); margin: 0.5rem 0 0 0;">Total Predictions</p>
                </div>
                <div
                    style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
                    <h3 style="color: #065f46; margin: 0; font-size: 2rem;">
                        {% set unique_symptoms = [] %}
                        {% for prediction in predictions %}
                        {% for symptom in prediction.symptoms %}
                        {% if symptom not in unique_symptoms %}
                        {% set _ = unique_symptoms.append(symptom) %}
                        {% endif %}
                        {% endfor %}
                        {% endfor %}
                        {{ unique_symptoms|length }}
                    </h3>
                    <p style="color: #065f46; margin: 0.5rem 0 0 0;">Unique Symptoms</p>
                </div>
                <div
                    style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
                    <h3 style="color: #92400e; margin: 0; font-size: 2rem;">
                        {% if predictions %}
                        {{ predictions[0].timestamp.split(' ')[0] }}
                        {% else %}
                        N/A
                        {% endif %}
                    </h3>
                    <p style="color: #92400e; margin: 0.5rem 0 0 0;">Last Prediction</p>
                </div>
            </div>

            <br>
            <div style="display: flex; gap: 1rem; justify-content: right; flex-wrap: wrap; margin-bottom: 2rem;">
                <a href="{{ url_for('index_form') }}" class="btn">
                    ‚ûï New Prediction
                </a>
                <br><a style="color:transparent"> -------------------------------------------------------</a>
                <button onclick="exportPredictionsPDF()" class="btn btn-secondary">
                    üìÑ Export PDF
                </button>
                <button onclick="clearHistory()" class="btn btn-outline"
                    style="margin-right:10px;color: var(--error); border-color: var(--error); background:red; color:white;">
                    üóëÔ∏è Clear History
                </button>
            </div>

            {% if predictions %}
            {% for prediction in predictions %}
            <div class="prediction-card" data-prediction-index="{{ loop.index0 }}" data-timestamp="{{ prediction.timestamp }}" style="position: relative;">
                <div class="prediction-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h3 style="color: var(--primary-color); margin: 0;">
                            Prediction #{{ loop.index }}
                        </h3>
                        <span class="prediction-date" style="display: block; margin-top: 0.25rem;">
                            {{ prediction.timestamp }}
                        </span>
                    </div>
                    <button onclick="deleteSinglePrediction({{ loop.index0 }}, '{{ prediction.timestamp }}')"
                            class="delete-prediction-btn"
                            title="Delete this prediction"
                            style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 14px; transition: all 0.2s; margin-left: 1rem;">
                        Delete
                    </button>
                </div>

                {% if prediction.symptoms %}
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.9rem;">
                        üìã Symptoms Reported:
                    </h4>
                    <div class="symptoms-list">
                        {% for symptom in prediction.symptoms %}
                        {% if symptom %}
                        <span class="symptom-tag">{{ symptom.replace('_', ' ').title() }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div>
                    <h4 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.9rem;">
                        üéØ Predicted Conditions (Top {{ prediction.top_n }}):
                    </h4>
                    <div class="diseases-list">
                        {% for disease in prediction.diseases %}
                        {% if disease %}
                        <span class="disease-tag">{{ loop.index }}. {{ disease }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div
                style="text-align: center; padding: 3rem; background: var(--surface); border-radius: var(--border-radius); box-shadow: var(--shadow);">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üîç</div>
                <h3 style="color: var(--text-secondary); margin-bottom: 1rem;">No Predictions Yet</h3>
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                    You haven't made any health predictions yet. Start by entering your symptoms to get personalized
                    health insights.
                </p>
                <a href="{{ url_for('index') }}" class="btn">
                    ü©∫ Make Your First Prediction
                </a>
            </div>
            {% endif %}

            <div style="display: flex; justify-content: space-between;">
            </div>
        </div>
    </div>
    <br><br>
    <footer class="site-footer" id="sf">
        <div class="footer-content"><br><br>
            <div class="footer-grid">
                <div class="footer-section">
                    <h3>üè• About mProvMeds</h3>
                    <p style="text-align:justify;">We are a team of dedicated individuals working to provide valuable
                        predictions and insights into various diseases based on symptoms input. Our goal is to improve
                        healthcare outcomes and empower individuals to make informed decisions about their health.</p>
                     <a href="#" title="LinkedIn"
                        style="display: inline-flex;align-items: center;justify-content: center;margin-top:0.6rem;letter-spacing:2.5px;">
                        <img style="margin-right:4px;" src="https://www.svgrepo.com/show/157006/linkedin.svg"
                            height="22.5" width="22.5">
                        LinkedIn

                    </a>
                    <a style="color:transparent;height:rem;">_</a>
                    <a style="border-left: 3px solid #2563eb;color:transparent;height:2rem;font-size:2rem;">_</a>
                    <a href="#" title="Github"
                        style="display: inline-flex;align-items: center;justify-content: center;margin-top:0.6rem;letter-spacing:2.5px;">
                        <img style="margin-right:4px;" src="https://www.svgrepo.com/show/512317/github-142.svg"
                            height="22.5" width="22.5">
                        Github

                    </a>

                </div>

                <div class="footer-section" style="padding-left:45px;">
                    <h3>üîó Quick Links</h3>
                    <ul>
                        <li><a href="{{ url_for('index') }}">üè† Home</a></li>
                        <li><a href="{{ url_for('index_form') }}">‚ûï Create New Prediction</a></li>
                        <li><a href="{{ url_for('my_predictions') }}">üìä My Predictions</a></li>
                        <li><a href="{{ url_for('about') }}">‚ÑπÔ∏è About Us</a></li>
                        <li>
                            <p style="font-size:0%;">.</p>
                        </li>
                        <li>
                            <p style="font-size:0%;">.</p>
                        </li>
                        <li><a href="{{ url_for('contact') }}">üìû Contact Support</a></li>
                        <li><a href="#">üìã Terms of Service</a></li>
                        <li><a href="#">üîí Privacy Policy</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3>üìç Contact Information</h3>
                    <p>üìß Email:<br> <a href="mailto:{{ support_email }}">{{ support_email }}</a></p>
                    <p style="font-size:0%;">.</p>
                    <p>üì± Phone:<br> {{ support_phone }}</p>
                    <p style="font-size:0%;">.</p>
                    <p>üè¢ Address: <br>Academic Office, VIT Bhopal University,<br>
                        Bhopal, Madhya Pradesh, India</p>
                    <p style="font-size:0%;">.</p>
                </div>
            </div>
            <br>

            <div class="disclaimer-box">
                <h4>‚ö†Ô∏è Important Medical Disclaimer</h4>
                <p style="text-align:justify; color: #dfdfdf">This application is for informational and educational
                    purposes only. It is not intended to be a substitute for professional medical advice, diagnosis, or
                    treatment. Always seek the advice of your physician or other qualified health provider with any
                    questions you may have regarding a medical condition. Never disregard professional medical advice or
                    delay in seeking it because of something you have read on this application.</p>
            </div>

            <div class="footer-bottom">
                <div class="copyright-info">
                    <p style="font-size:1rem;"><br>
                        &copy; 2023 mProvMeds - Healthcare Improvements Platform. All rights reserved. | Powered by
                        NAMETAG</p>
                </div>

                <p style="margin-top: 1rem; color: #d1d5db; font-size: 0.9rem;">
                    Version {{ver}} | Last Updated: {{updatedOn}} |
                    <a href="{{ url_for('contact') }}" style="color: #93c5fd;">Report Issues</a> |
                    <a href="{{ url_for('contact') }}" style="color: #93c5fd;">Suggest Features</a>|
                    <a href="{{ url_for('view_all_queries') }}" style="color: #93c5fd;">Admin Console</a>
                </p>
                <p style="margin-top: 1rem; color: #d1d5db; font-size: 0.9rem;">
                    <a href="https://www.python.org/" target="_blank" style="color: #93c5fd; font-size: 0.75rem;">
                        Python</a> |
                    <a href="https://www.google.com/search?q=machine+learning&rlz=1C1VDKB_enIN988IN988&oq=MAchine&gs_lcrp=EgZjaHJvbWUqDwgBEAAYQxixAxiABBiKBTIMCAAQRRg5GLEDGIAEMg8IARAAGEMYsQMYgAQYigUyCggCEAAYsQMYgAQyBwgDEAAYgAQyBwgEEAAYgAQyCggFEAAYsQMYgAQyBggGEEUYPTIGCAcQRRhB0gEIMzU1NmowajSoAgCwAgA&sourceid=chrome&ie=UTF-8"
                        target="_blank" style="color: #93c5fd; font-size: 0.75rem;">
                        Machine Learning</a> |
                    <a href="https://flask.palletsprojects.com" target="_blank"
                        style="color: #93c5fd; font-size: 0.75rem;">
                        Flask</a> |
                    <a href="https://www.google.com/search?q=html+css&sca_esv=71a2141a21d8c97d&rlz=1C1VDKB_enIN988IN988&sxsrf=AE3TifMumyHis7wMC95WamCUIAtFR_neXg%3A1756302710342&ei=dg2vaKzfFOrdseMP2722-A4&ved=0ahUKEwis8qu5kauPAxXqbmwGHdueDe8Q4dUDCBA&uact=5&oq=html+css&gs_lp=Egxnd3Mtd2l6LXNlcnAiCGh0bWwgY3NzMgUQABiABDIFEAAYgAQyCBAAGIAEGLEDMgUQABiABDIFEAAYgAQyBRAAGIAEMgUQABiABDIFEAAYgAQyBRAAGIAEMggQABiABBixA0ixL1CHKVjRLnACeAGQAQCYAcUBoAGFBKoBAzAuM7gBA8gBAPgBAZgCBaACsgTCAgcQIxiwAxgnwgIKEAAYsAMY1gQYR8ICChAjGIAEGCcYigXCAg0QABiABBixAxhDGIoFwgIKEAAYgAQYQxiKBcICDhAAGIAEGLEDGIMBGIoFwgILEAAYgAQYsQMYgwGYAwCIBgGQBgqSBwUyLjIuMaAHhxOyBwUwLjIuMbgHmwTCBwUyLTQuMcgHJQ&sclient=gws-wiz-serp"
                        target="_blank" style="color: #93c5fd; font-size: 0.75rem;">
                        HTML5/CSS3</a> |
                    <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank"
                        style="color: #93c5fd; font-size: 0.75rem;">
                        JavaScript</a> |
                    <a href="https://developer.mozilla.org/en-US/docs/Learn_web_development/Core/CSS_layout/Responsive_Design"
                        target="_blank" style="color: #93c5fd; font-size: 0.75rem;">
                        Responsive Design</a>
                </p>
            </div>
        </div>
    </footer>

    <script id="predictions-data" type="application/json">
        {{ predictions|tojson|safe }}
    </script>

    <script id="user-data" type="application/json">
        {
            "username": "{{ username|default('Guest') }}",
            "email": "{{ email|default('N/A') }}"
        }
    </script>

    <script>
        // Export predictions as PDF
        function exportPredictionsPDF() {
            try {
                // Get data from script tags
                const predictionsData = JSON.parse(document.getElementById('predictions-data').textContent);
                const userData = JSON.parse(document.getElementById('user-data').textContent);

                if (predictionsData.length === 0) {
                    alert("No predictions to export!");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('mProvMeds - Predictions Information', 20, 20);

                // User info
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Name: ${userData.username}`, 20, 35);
                doc.text(`Email: ${userData.email}`, 20, 45);
                doc.text(`Date: ${new Date().toLocaleString()}`, 20, 55);

                // Line separator
                doc.line(20, 65, 190, 65);

                // Prepare table data
                const tableData = [];
                predictionsData.forEach((prediction, index) => {
                    const symptoms = prediction.symptoms ? prediction.symptoms.join(', ').replace(/_/g, ' ') : 'None';
                    const diseases = prediction.diseases ? prediction.diseases.join('\n') : 'None';

                    tableData.push([
                        (index + 1).toString(),
                        prediction.timestamp.replace(' ','\n') || 'N/A',
                        symptoms,
                        diseases
                    ]);
                });

                // Create table
                doc.autoTable({
                    startY: 75,
                    head: [['Sr No.', 'Date Time', 'Symptoms Submitted', 'Predicted Prognosis']],
                    body: tableData,
                    theme: 'grid',
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                    },
                    headStyles: {
                        fillColor: [37, 99, 235],
                        textColor: 255,
                        fontSize: 11,
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { cellWidth: 15 },
                        1: { cellWidth: 35 },
                        2: { cellWidth: 65 },
                        3: { cellWidth: 65 }
                    },
                    margin: { left: 20, right: 20 }
                });

                // Save the PDF
                const filename = `mProvMeds_Predictions_${userData.username}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);

            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Error exporting PDF. Please try again.');
            }
        }

        // Custom confirmation dialog
        function showConfirm(title, message, icon = '‚ö†Ô∏è', onConfirm = null, onCancel = null) {
            return new Promise((resolve) => {
                const alertDialog = document.getElementById('alertDialog');
                const alertTitle = document.getElementById('alert-title');
                const alertMessage = document.getElementById('alert-message');
                const alertIcon = document.getElementById('alert-icon');
                const confirmBtn = document.getElementById('alert-confirm');
                const cancelBtn = document.getElementById('alert-cancel');

                // Set content
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertIcon.textContent = icon;

                // Setup button handlers
                const handleConfirm = () => {
                    alertDialog.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    if (onConfirm) onConfirm();
                    resolve(true);
                };

                const handleCancel = () => {
                    alertDialog.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    if (onCancel) onCancel();
                    resolve(false);
                };

                // Remove previous event listeners
                const newConfirmBtn = confirmBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                // Add new event listeners
                newConfirmBtn.addEventListener('click', handleConfirm);
                newCancelBtn.addEventListener('click', handleCancel);

                // Show dialog
                alertDialog.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                // Focus on cancel button by default
                newCancelBtn.focus();
            });
        }

        // Clear history function-->
        function clearHistory() {

            if (confirm('Are you sure you want to clear all prediction history? This action cannot be undone.')) {
                // You'll need to implement this endpoint in your Flask app
                fetch('/clear_predictions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(true);
                        window.reload(true);
                        alert('All Predictions were deleted successfully.');
                        showConfirm('Deleting...','All Predictions were deleted successfully!!',
                        '‚úÖ');
                    }
                    //else {
                        //alert(' inner Error clearing history. Please try again.');
                    //}
                })
                //.catch(error => {
                    //console.error('Error:', error);
                    //alert(' outer Error clearing history. Please try again.');
                //});
                location.reload(true);
                window.reload(true);
            }
        }

        // Delete single prediction function
        async function deleteSinglePrediction(predictionIndex, timestamp) {
            if (confirm('Are you sure you want to clear all prediction history? This action cannot be undone.')) {
                // You'll need to implement this endpoint in your Flask app
                fetch('/delete/this/prediction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        timestamp: timestamp
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(true);
                        window.reload(true);
                        alert('All Predictions were deleted successfully.');
                        showConfirm('Deleting...','All Predictions were deleted successfully!!',
                        '‚úÖ');
                    }
                    //else {
                        //alert(' inner Error clearing history. Please try again.');
                    //}
                })
                //.catch(error => {
                    //console.error('Error:', error);
                    //alert(' outer Error clearing history. Please try again.');
                //});
                location.reload(true);
                window.reload(true);
            }
        }

        // Add hover effects to delete buttons
        document.addEventListener('DOMContentLoaded', function() {
            const deleteButtons = document.querySelectorAll('.delete-prediction-btn');

            deleteButtons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.background = '#fee2e2';
                    this.style.borderColor = '#fca5a5';
                    this.style.transform = 'scale(1.05)';
                });

                button.addEventListener('mouseleave', function() {
                    this.style.background = '#fef2f2';
                    this.style.borderColor = '#fecaca';
                    this.style.transform = 'scale(1)';
                });
            });
        });

        // Toggle dropdown function
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('dropdownMenu');
            const userButton = document.querySelector('.user-button');

            if (userButton && !userButton.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
    </script>
</body>

</html>
